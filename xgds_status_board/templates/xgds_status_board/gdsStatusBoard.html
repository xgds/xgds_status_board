{% extends "base.html" %}
{% block headExtras %}
<script src="{{ MEDIA_URL }}external/js/jquery.min.js"></script>
<script src="{{ MEDIA_URL }}jquery/js/jquery.countdown.js"></script>
<script src="{{ MEDIA_URL }}jquery/js/jquery.timers-1.2.js"></script>
<script type="text/javascript">
var myDates = [];
var scheduleItemCount = 0;
var lastScheduleHTML = "";

// these will be populated by the server timestamp
var today = new Date();
var now = new Date();

$(function () {
//	$('#elapsedTimeField').countdown({since: today, format: "HM", compact:true});
        updateDynamicElements();
//	$('#scheduleTimer1').countdown({until: new Date(myDates[0]), format:"HM", compact:true});
        $(window).everyTime('10s', function(i) { updateDynamicElements() });
});

function updateDynamicElements() {
	{% block updateDynamicJavascript %}
  		updateServerTimestamp();
  		{% if STATUS_BOARD_ANNOUNCEMENTS %}
  		updateAnnouncements();
  		{% endif %}
  		
  		{% if STATUS_BOARD_SCHEDULE %}
  		updateSchedule();
  		{% endif %}
  		
  		{% if STATUS_BOARD_SCORE_SCHEDULE %}
  		updateSCORESchedule();
  		{% endif %}
	{% endblock updateDynamicJavascript %}

}

function updateServerTimestamp() {
  $.getJSON('{% url serverDatetime.json %}', function(data) {
	 $.each(data,function(index, value) {
	 	// populate todays date
	 	if (index == {{STATUS_BOARD_DATE_TIMEZONE_INDEX}}){
		 	dateStr = value.dayName + " " + value.month + "/" + value.day;
	      	$('#date').html(dateStr);
	      	
	      	// Javascript dates have the month starting from 0.
	      	today = new Date(value.year, value.month - 1, value.day);
	      	now = new Date(value.year, value.month - 1, value.day, value.hour, value.min);
	      	//console.log("now is " + now);
	      	
	      	$('#today_timezonelabel').html("In " + value.zonelabel + " time");
	 	}
	 	
	 	// populate the times
      	timestampStr = value.zonelabel + ": "  + value.hour + ":" + value.min
      	var elementname = '#time' + (index+1)
      	$(elementname).html(timestampStr);
	 })
  })
}

function zeroPad(num,count)
{
	var numZeropad = num + '';
	while(numZeropad.length < count) {
		numZeropad = "0" + numZeropad;
	}
	return numZeropad;
}

{% if STATUS_BOARD_ANNOUNCEMENTS %}
function updateAnnouncements() {
  $.get('{% url announcements %}', function(data) {
    $('#announceSection').html(data);
  })
}
{% endif %}

{% if STATUS_BOARD_SCHEDULE %}
function updateSchedule() {
  $.getJSON('{% url schedule.json %}', function(data) {
    if (lastScheduleHTML != data.schedHtml) {
      $('#scheduleSection').html(data.schedHtml);
      myDates = data.localTimes;
      scheduleItemCount = data.dateCount;
      if (scheduleItemCount != 0) {
//        $('#scheduleTimer1').countdown({until: new Date(myDates[0]),
//          format:"HM", compact:true});
		updateSchedRows();
      }
    }
    lastScheduleHTML = data.schedHtml;
  })
}

function selectSchedRow(num) {
	var row = 0;
	var timerFieldSelector = '';

	for (i=1; i<=scheduleItemCount; i++) {
		row = document.getElementById('schedRow' + i);
		if (row != null){
			row.className = '';
		}
		timerFieldSelector = '#scheduleTimer' + i;
		$(timerFieldSelector).countdown('destroy');
	}
	row = document.getElementById('schedRow' + num);
	row.className = 'boldClass';
	timerFieldSelector = '#scheduleTimer' + num;
	$(timerFieldSelector).countdown({until: new Date(myDates[num-1]), format:"HM", compact:true});
}

function updateSchedRows() {
        var row = 0;
        var timerFieldSelector = '';

        for (i=1; i<=scheduleItemCount; i++) {
                row = document.getElementById('schedRow' + i);
                if (row != null){
                	row.className = 'boldClass';
        		}
                timerFieldSelector = '#scheduleTimer' + i;
        	$(timerFieldSelector).countdown({until: new Date(myDates[i-1]), format:"HM", compact:true});
	}
}

{% endif %}
</script>
{% endblock headExtras %}
{% block cssExtras %}
    <link rel="stylesheet" type="text/css" href="{{ MEDIA_URL }}style/status_board.css" ></link>
{% endblock %}
{% block contents %}

<span class="statusboard">

{% if STATUS_BOARD_ANNOUNCEMENTS %}
{% block preAnnouncements %}
{% endblock preAnnouncements %}
{% block announcements %}
<h2 class="h2">Announcements</h2>
<span id='announceSection'></span>
{% endblock announcements %}
{% endif %}


{% if STATUS_BOARD_SCHEDULE %}
{% block preSchedule %}
{% endblock preSchedule %}
{% block schedule %}
<h2 class="h2"><br/>Schedule</h2>
<span id='scheduleSection'></span>
{% endblock schedule %}
{% endif %}

{% if STATUS_BOARD_SCORE_SCHEDULE %}
{% block preScoreSchedule %}
{% endblock preScoreSchedule %}
{% block scoreSchedule %}
<h2 class="h2"><br/>SCORE Schedule <span class='{{today_timeclass}}' id="today_timezonelabel"></span></h2>
{% include "xgds_status_board/ScheduleFromSCORE.html" %}
{% endblock scoreSchedule %}
{% endif %}

{% block details %}
{% endblock details %}
</span>

<span class='linkblock'>
{% block currentTime %}
  <span class='time'>
  	<span class='{{today_timeclass}}' id="date"></span><br/>
  	{% for t in STATUS_BOARD_TIMEZONES %}
  		<span class='time{{forloop.counter}}' id="time{{forloop.counter}}" ></span><br/>
  	{% endfor %}
  </span>
{% endblock currentTime %}
{% block links %}
{% endblock links %}
</span>
{% endblock contents %}
